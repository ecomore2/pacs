---
title: "Summary of the state of the PACS data set"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.
-->

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r general_options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(margin = TRUE, prompt = TRUE, comment = "", echo = FALSE,
                      collapse = TRUE, cache = FALSE, autodep = TRUE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 137)
```

```{r eval = FALSE}
if (! "readr" %in% rownames(installed.packages())) install.packages("readr")
pacs <- readr::read_csv("https://raw.githubusercontent.com/ecomore2/pacs/master/data/pacs.csv",
                        col_types = paste(c("icfnD", rep("c", 5), rep("D", 4), rep("f", 3)), collapse = ""))
```

```{r include = FALSE}
pacs <- readr::read_csv("data/pacs.csv",
                        col_types = paste(c("icfnD", rep("c", 5), rep("D", 4), rep("f", 3)), collapse = ""))
```

```{r message = FALSE}
library(magrittr)
library(dplyr)
library(lubridate)
library(padr)
library(sfsmisc)
```

```{r}
if (!dir.exists("problems")) dir.create("problems")
```

The CSV file of the **PACS data set** is
[here](https://github.com/ecomore2/pacs/blob/master/data/pacs.csv). Go [here](https://raw.githubusercontent.com/ecomore2/pacs/master/data/pacs.csv)
if you want to copy and paste this CSV file to your computer.

## Dates of reported cases

```{r time_range_of_pacs}
mindate <- pacs %>%
  select(onset, hospitalization, consultation, sample_collection) %>% 
  lapply(min, na.rm = TRUE) %>% 
  purrr::reduce(c) %>% 
  min()

maxdate <- pacs %>%
  select(onset, hospitalization, consultation, sample_collection) %>% 
  lapply(max, na.rm = TRUE) %>% 
  purrr::reduce(c) %>% 
  max()
```

```{r problems_in_dates}
threshold <- 15
problems <- pacs %>% 
  mutate(onset_hospitalization             = as.integer(onset           - hospitalization),
         onset_consultation                = as.integer(onset           - consultation),
         onset_sample_collection           = as.integer(onset           - sample_collection),
         hospitalization_consultation      = as.integer(hospitalization - consultation),
         hospitalization_sample_collection = as.integer(hospitalization - sample_collection),
         consultation_sample_collection    = as.integer(consultation    - sample_collection)) %>% 
  filter(abs(onset_hospitalization)             > threshold |
         abs(onset_consultation)                > threshold |
         abs(onset_sample_collection)           > threshold |
         abs(hospitalization_consultation)      > threshold |
         abs(hospitalization_sample_collection) > threshold |
         abs(consultation_sample_collection)    > threshold) %>% 
  select(id, onset, hospitalization, consultation, sample_collection)

write.csv(problems, "problems/dates.csv", FALSE, row.names = FALSE)
```

```{r number_of_cases_with_no_dates}
no_dates <- pacs %>%
  filter(is.na(onset), is.na(hospitalization), is.na(consultation), is.na(sample_collection)) %>% 
  select(id, onset, hospitalization, consultation, sample_collection)
write.csv(no_dates, "problems/no_dates.csv", FALSE, row.names = FALSE)
```

As of `r as.Date(Sys.time())`, the PACS data set contains **`r nrow(pacs)` cases**
reported from **`r mindate`** to **`r maxdate`**. There are `r nrow(problems)` cases for
which there are more than `r threshold` days between at least one pair of dates
among onset, consultation, hospitalization and sample collection. A CSV file of
these cases is [here](https://github.com/ecomore2/pacs/blob/master/problems/dates.csv).
Go [here](https://raw.githubusercontent.com/ecomore2/pacs/master/problems/dates.csv)
if you want to copy and paste this CSV file to your computer. Furthermore, there
are `r nrow(no_dates)` cases with no date at all. A CSV file of these cases is
[here](https://github.com/ecomore2/pacs/blob/master/problems/no_dates.csv).
Go [here](https://raw.githubusercontent.com/ecomore2/pacs/master/problems/no_dates.csv)
if you want to copy and paste this CSV file to your computer. After removing these
**`r nrow(problems)` cases with date problems** as well as the **`r nrow(no_dates)`
cases with no dates at all** and inferring the missing onset dates from other dates
as explained [here](https://ecomore2.github.io/pacs/explore_data.html), the
time series of the number of suspected cases per week looks like:

```{r time_series, fig.width = 8}
corrections <- dates_diff <- pacs %>% 
  mutate(onset_hospitalization             = as.integer(onset           - hospitalization),
         onset_consultation                = as.integer(onset           - consultation),
         onset_sample_collection           = as.integer(onset           - sample_collection),
         hospitalization_consultation      = as.integer(hospitalization - consultation),
         hospitalization_sample_collection = as.integer(hospitalization - sample_collection),
         consultation_sample_collection    = as.integer(consultation    - sample_collection)) %>% 
  filter(abs(onset_hospitalization)             < threshold,
         abs(onset_consultation)                < threshold,
         abs(onset_sample_collection)           < threshold,
         abs(hospitalization_consultation)      < threshold,
         abs(hospitalization_sample_collection) < threshold,
         abs(consultation_sample_collection)    < threshold) %>% 
  select(contains("onset_")) %>% 
  sapply(mean) %>% 
  round()

byweek <- pacs %>% 
  mutate(onset2 = if_else(is.na(onset),
                          if_else(is.na(hospitalization),
                                  if_else(is.na(consultation),
                                          sample_collection + corrections["onset_sample_collection"],
                                          consultation + corrections["onset_consultation"]),
                                  hospitalization + corrections["onset_hospitalization"]),
                          onset)) %>% 
  select(-dob, -onset, -hospitalization, -consultation, -sample_collection) %>% 
  filter(! is.na(onset2)) %>% 
  thicken("week") %>% 
  select(-onset2) %>% 
  group_by(onset2_week) %>% 
  tally() %>% 
  ungroup() %>% 
  pad("week")

lab <- min(year(byweek$onset2_week)):(max(year(byweek$onset2_week)) + 1)
ats <- as.Date(paste0(lab, "-01-01"))

with(byweek, plot(onset2_week, n, type = "h", col = "blue", xlab = NA,
                  ylab = "number of suspected cases", axes = FALSE, xlim = range(ats)))

axis(1, ats, lab); axis(2)
abline(v = ats, col = "grey")
abline(h = seq(25, 150, 25), col = "grey")
```

## PCR and NS1 tests

```{r}
f <- function(x) ifelse(is.na(x), "NA", x)
g <- function(x)
  factor(sub("_", " ", x),
         c("positive", "equivocal", "negative", "not finished", "not tested", "NA"))
```

```{r}
positives <- pacs %>% 
  filter(pcr == "positive" | ns1 == "positive") %>% 
  nrow()
negatives <- pacs %>% 
  filter(pcr == "negative", ns1 == "negative") %>% 
  nrow()
```

Out of the `r nrow(pacs)` reported cases,
`r positives + negatives` (`r round(100 * (positives + negatives) / nrow(pacs))` %)
have a conclusive confirmation test, of which
`r positives` (`r round(100 * positives / (positives + negatives))` %) are positive:

```{r}
pacs %>% 
  mutate(PCR = g(f(as.character(pcr))),
         NS1 = g(f(as.character(ns1)))) %$%
  table(PCR, NS1) %>% 
  addmargins()
```

Stratifying by the reported cases with or without problem in missing dates (i.e.
the `r nrow(problems)` cases with date problems as well as the `r nrow(no_dates)`
cases with no dates at all), it gives:

```{r}
tmp <- pacs %>% 
  mutate(PCR = g(f(as.character(pcr))),
         NS1 = g(f(as.character(ns1))),
         missing_date = id %in% c(problems$id, no_dates$id))
```

```{r}
tmp %>%
  dplyr::filter(missing_date) %$% 
  table(PCR, NS1) %>% 
  addmargins()
```

and 

```{r}
tmp %>%
  filter(! missing_date) %$% 
  table(PCR, NS1) %>% 
  addmargins()
```

```{r}
tmp %<>% filter(province == "Vientiane [prefecture]")
positives <- tmp %>% 
  filter(pcr == "positive" | ns1 == "positive") %>% 
  nrow()
negatives <- tmp %>% 
  filter(pcr == "negative", ns1 == "negative") %>% 
  nrow()
```

Out of the `r nrow(tmp)` cases reported from Vientiane prefecture,
`r positives + negatives` (`r round(100 * (positives + negatives) / nrow(tmp))` %)
have a conclusive confirmation test, of which
`r positives` (`r round(100 * positives / (positives + negatives))` %) are positive:

```{r}
tmp %$% 
  table(PCR, NS1) %>% 
  addmargins()
```

## Serotypes

The status of the serotypes tests is as follow:

```{r}
pacs %>% 
  mutate(serotype = factor(f(as.character(serotype)),
                           c("dengue_1", "dengue_2", "dengue_3", "dengue_4", "not_identified", "not_finished", "not_tested", "NA"))) %$% 
  table(serotype) %>%
  (function(x) lapply(c(names, as.vector), function(f) f(x))) %>%
  data.frame() %>%
  setNames(c("status", "n"))
```

## Geography

The number of missing values for province, district and village:

```{r}
pacs %>% 
  transmute(province = is.na(province),
            district = is.na(district),
            village  = is.na(village)) %>% 
  lapply(table)
```

The reported cases with village information but missing province information:

```{r}
pacs %>%
  filter(is.na(province), ! is.na(village)) %>% 
  select(id, province, district, village)
```

The reported cases with district information but missing province information:

```{r}
pacs %>%
  filter(is.na(province), ! is.na(district)) %>% 
  select(id, province, district, village)
```

```{r}
for(f in c("gadm36_LAO_0_sf.rds", "gadm36_LAO_1_sf.rds", "gadm36_LAO_2_sf.rds"))
  if(! file.exists(f))
    download.file(paste0("https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/", f), f)
```

The provinces names that are not official Lao province name:

```{r message = FALSE}
library(sf)
lao1 <- readRDS("gadm36_LAO_1_sf.rds")
lao2 <- readRDS("gadm36_LAO_2_sf.rds")
setdiff(unique(pacs$province), lao1$NAME_1)
```

```{r}
vt <- pacs %>% 
  filter(! is.na(province)) %>% 
  mutate(vientiane = province == "Vientiane [prefecture]") %$%
  mean(vientiane)
```

`r round(100 * vt)` % of reported cases
(`r sum(pacs$province == "Vientiane [prefecture]", na.rm = TRUE)`) are from
Vientiane prefecture:

```{r}
pacs %>% 
  group_by(province) %>% 
  tally() %>% 
  ungroup() %>% 
  arrange(desc(n)) %>% 
  print(n = 25)
```

The distribution of cases among the different districts of Vientiane prefecture
looks like:

```{r}
pacs %>% 
  filter(province == "Vientiane [prefecture]") %>% 
  group_by(district) %>% 
  tally() %>% 
  ungroup() %>% 
  arrange(desc(n))
```

## Ages

```{r}
tmp <- pacs %>% 
  mutate(onset2 = if_else(is.na(onset),
                          if_else(is.na(hospitalization),
                                  if_else(is.na(consultation),
                                          sample_collection + corrections["onset_sample_collection"],
                                          consultation + corrections["onset_consultation"]),
                                  hospitalization + corrections["onset_hospitalization"]),
                          onset),
         age2 = as.numeric((onset2 - dob) / 365))
```

For the reported cases below, the dates of birth are not compatible with the age.
It seems that the year of the date of birth has incorrectly been taken as the
same as the year of the onset:

```{r}
tmp %>%
  filter(age2 < 0) %>% 
  select(id, dob, age, onset2)
```

```{r}
mod <- lm(age2 ~ age, tmp)
cft <- coef(mod)
threshold <- 2
age_check <- tmp %>% 
  filter(age2 > cft[1] + cft[2] * age + threshold | age2 < cft[1] + cft[2] * age - threshold, age2 > 0) %>% 
  select(id, dob, onset, hospitalization, consultation, sample_collection, onset2, age, age2)
write.csv(age_check, "problems/age_check.csv", FALSE, row.names = FALSE)
```

There are `r nrow(age_check)` cases for which the reported age, onset, and date
of birth are not quite compatible:

```{r}
age_check
```

where `onset2` is calculated from `onset`, `hospitalization`, `consultation` and
`sample_collection`, and `age2 = onset2 - dob`. A CVS file of all the case is
[here](https://github.com/ecomore2/pacs/blob/master/problems/age_check.csv). Go
[here](https://raw.githubusercontent.com/ecomore2/pacs/master/problems/age_check.csv)
if you want to copy and paste this CSV file to your computer.
